const h="https://www.soundcloud.com/",k="https://api-v2.soundcloud.com/";class m{constructor(s){this.proxy=s,this.getClientId=async t=>{if(!this.clientId||t){let i=h;this.proxy&&(i=this.proxy+h);const r=(await(await application.networkRequest(i)).text()).match(/(?!<script crossorigin src=")https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*\.js)(?=">)/g);let o;do o=await(await application.networkRequest(r?.pop()||"")).text();while(!o.includes(',client_id:"')&&(r?.length||0)>0);this.clientId=o.match(/,client_id:"(\w+)"/)?.[1],this.clientId||Promise.reject("Unable to fetch a SoundCloud API key.")}return this.clientId},this.getV2=async(t,i)=>{i||(i={}),i.client_id=await this.getClientId();let e=t=k+t;this.proxy&&(e=this.proxy+t);const a=new URL(e);try{return a.search=new URLSearchParams(i).toString(),await(await application.networkRequest(a.toString())).json()}catch{return i.client_id=await this.getClientId(!0),a.search=new URLSearchParams(i).toString(),await(await application.networkRequest(a.toString())).json()}}}}class p{constructor(s){this.searchTracksV2=async t=>await this.api.getV2("search/tracks",t),this.searchPlaylistsV2=async t=>await this.api.getV2("search/playlists",t),this.resolveV2=async t=>{!String(t).match(/\d{8,}/)&&!String(t).includes("soundcloud")&&(t=`https://soundcloud.com/${t}`);let i=t;return String(t).includes("soundcloud")&&(i=(await this.api.getV2("resolve",{url:t})).id),i},this.getTrackV2=async t=>{const i=await this.resolveV2(t);return await this.api.getV2(`tracks/${i}`)},this.getTracksArrayV2=async t=>{if(t.length===0)return[];const i=[];let e=0;for(;e<t.length;)i.push(t.slice(e,e+=50));const a=[],r=await Promise.all(i.map(o=>this.api.getV2("tracks",{ids:o.join(",")})));return a.concat(...r)},this.fetchPlaylistTracks=async t=>{const i=t.tracks.splice(t.tracks.findIndex(e=>!e.title)).map(e=>e.id);return i.length===0||(t.tracks=t.tracks.concat(await this.getTracksArrayV2(i))),t},this.getPlaylistV2=async t=>{const i=await this.resolveV2(t),e=await this.api.getV2(`playlists/${i}`);return this.fetchPlaylistTracks(e)},this.getTopPlaylistsV2=async()=>await this.api.getV2("mixed-selections"),this.api=new m(s)}}const d=c=>{let s=c.artwork_url?c.artwork_url:c.user?.avatar_url;return s?[{url:s,height:100,width:100},{url:s.replace("-large","-t500x500"),height:500,width:500}]:[]},g=c=>({name:c.title,apiId:c.id.toString(),images:d(c)});class f{constructor(s){this.soundcloud=s,this.soundcloudTrackToTrack=t=>({name:t.title,apiId:t.id.toString(),duration:t.duration/1e3,artistName:t.publisher_metadata?.artist||"",source:t.media.transcodings.find(this.trackFilter.bind(this))?.url,images:d(t)})}trackFilter(s){return this.progressiveFilter(s)||this.hlsFilter(s)}progressiveFilter(s){return s.format.mime_type==="audio/mpeg"&&s.format.protocol==="progressive"}hlsFilter(s){return s.format.mime_type==="audio/mpeg"&&s.format.protocol==="hls"}async searchTracks(s){const i=s.pageInfo?.offset||0,e=await this.soundcloud?.searchTracksV2({q:s.query,limit:50,offset:i}),a=e?.collection.map(this.soundcloudTrackToTrack.bind(this)),r={offset:i,resultsPerPage:50,totalResults:e?.total_results||0};return{items:a?.filter(o=>!!o.source)||[],pageInfo:r}}async searchPlaylists(s){const i=s.pageInfo?.offset||0,e=await this.soundcloud?.searchPlaylistsV2({q:s.query,limit:50,offset:i}),a=e?.collection.map(g),r={offset:i,resultsPerPage:50,totalResults:e?.total_results||0};return{items:a||[],pageInfo:r}}async getPlaylistTracks(s){const t=await this.soundcloud.getPlaylistV2(s.apiId||"");return{items:t?.tracks.map(this.soundcloudTrackToTrack.bind(this))?.filter(e=>!!e.source)||[],playlist:t&&{name:t.title,apiId:t.id.toString(),images:d(t)}}}async searchAll(s){const t=this.searchTracks(s),i=this.searchPlaylists(s),[e,a]=await Promise.all([t,i]);return{tracks:e,playlists:a}}async getTopItems(){console.log("getTopItems");const s=await this.soundcloud.getTopPlaylistsV2();console.log("playlists",s);const t=s.collection.flatMap(i=>i.items.collection.map(g));return console.log("playlistInfos",t),{playlists:{items:t}}}async getTrackByUrl(s){const t=await application.isNetworkRequestCorsDisabled(),i=await application.getCorsProxy()||"https://cloudcors.audio-pwa.workers.dev/",e=t?"":i;let a=await this.soundcloud.api.getClientId();const r=await this.soundcloud.getTrackV2(s.apiId||"");let o=r?.media.transcodings.find(this.progressiveFilter.bind(this))?.url||"";o||(o=r?.media.transcodings.find(this.hlsFilter.bind(this))?.url||"");let l="",u=o?.includes("secret_token")?`&client_id=${a}`:`?client_id=${a}`;try{l=(await(await application.networkRequest(e+o+u)).json()).url}catch{a=await this.soundcloud.api.getClientId(!0),u=o?.includes("secret_token")?`&client_id=${a}`:`?client_id=${a}`,l=(await(await application.networkRequest(e+o+u)).json()).url}return l}}const P="https://cloudcors.audio-pwa.workers.dev/",T=new p(P),n=new f(T);application.onSearchAll=n.searchAll.bind(n);application.onSearchTracks=n.searchTracks.bind(n);application.onSearchPlaylists=n.searchPlaylists.bind(n);application.onGetPlaylistTracks=n.getPlaylistTracks.bind(n);application.onGetTrackUrl=n.getTrackByUrl.bind(n);application.onGetTopItems=n.getTopItems.bind(n);const I=async()=>{const c=await application.isNetworkRequestCorsDisabled(),s=await application.getCorsProxy();c?n.soundcloud=new p:s&&(n.soundcloud=new p(s))};I();
